<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>New Message</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
:root{
  --pink:#f2a9c7;
  --pink2:rgba(242,169,199,.55);
  --bgpink:rgba(242,169,199,.45);
  --line:rgba(0,0,0,.18);
  --shadow:rgba(0,0,0,.12);
}

*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:24px;
  overflow-y:auto;
  background:
    repeating-linear-gradient(
      90deg,
      var(--bgpink) 0px,
      var(--bgpink) 22px,
      #fff 22px,
      #fff 48px
    );
}

.wrap{
  width:420px;
  max-width:95vw;
  margin:140px auto 40px;
}

/* ---------- LOCK ---------- */
.lock{
  background:#fff;
  border:2px solid var(--line);
  border-radius:20px;
  box-shadow:0 16px 36px var(--shadow);
  overflow:hidden;
}

.lockTop{
  padding:18px 16px 8px;
  text-align:center;
  font-family:'Press Start 2P', monospace;
}

.lockTop h1{
  font-size:14px;
  margin:6px 0 10px;
}

.lockTop p{
  font-size:10px;
  opacity:.7;
  margin-bottom:10px;
}

.dots{
  display:flex;
  justify-content:center;
  gap:6px;
  margin-bottom:8px;
}

.dot{
  width:12px;
  height:12px;
  border-radius:50%;
  border:2px solid var(--line);
}
.dot.filled{background:var(--pink)}

.err{
  height:16px;
  font-size:9px;
  color:#a33;
}

/* keypad */
.pad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  padding:14px;
  border-top:2px solid var(--line);
}

.key{
  padding:14px 0;
  font-family:'Press Start 2P', monospace;
  font-size:14px;
  border-radius:14px;
  border:2px solid var(--line);
  background:var(--pink);
  color:#fff;
  -webkit-tap-highlight-color: transparent;
}
.key.alt{
  background:#f7f7f7;
  color:#222;
  font-size:9px;
}
.spacer{visibility:hidden}

/* ---------- POPUP ---------- */
.popup{
  background:#fff;
  border-radius:20px;
  border:2px solid var(--line);
  overflow:hidden;
  width:360px;
  max-width:92vw;
  position:relative;

  /* sticker-ish shadow + soft blush ring */
  box-shadow:
    14px 14px 0 rgba(242,169,199,.55),
    0 0 0 6px rgba(242,169,199,.10);
}

.popupHeader{
  background:var(--pink2);
  padding:14px;
  text-align:center;
  font-family:'Press Start 2P', monospace;
  font-size:14px;
  position:relative;
  z-index:2;
}

/* cute window dots */
.windowDots{
  position:absolute;
  left:12px;
  top:12px;
  display:flex;
  gap:6px;
  z-index:3;
}
.windowDots span{
  width:10px; height:10px;
  border-radius:50%;
  border:2px solid var(--line);
  background:rgba(255,255,255,.75);
}
.windowDots span:nth-child(1){ background:rgba(242,169,199,.60); }
.windowDots span:nth-child(2){ background:rgba(255,255,255,.78); }
.windowDots span:nth-child(3){ background:rgba(242,169,199,.35); }

/* title + tracker stack */
.hdrLeft{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  padding-right:44px; /* leave room for music button */
  position:relative;
  z-index:3;
}

.dayTracker{
  font-family:'Press Start 2P', monospace;
  font-size:8px;
  line-height:1.35;
  padding:6px 8px;
  border-radius:999px;
  border:2px solid var(--line);
  background:rgba(255,255,255,.90);
  color:#222;
  max-width:260px;
  text-align:center;
  white-space:normal;
  letter-spacing:.2px;
}

/* music control button */
.musicBtn{
  position:absolute;
  right:10px;
  top:10px;
  width:34px;
  height:26px;
  border-radius:10px;
  border:2px solid var(--line);
  background:#fff;
  color:#222 !important;
  font-family:'Press Start 2P', monospace;
  font-size:10px;
  line-height:1;
  display:flex;
  align-items:center;
  justify-content:center;
  -webkit-appearance:none;
  appearance:none;
  padding:0;
  z-index:6;
  -webkit-tap-highlight-color: transparent;
}
.musicBtn:active{transform:translateY(1px)}
.musicBtn.on{ background:rgba(242,169,199,.35); }

.popupBody{
  padding:18px 16px;
  min-height:120px;
  font-family:'Press Start 2P', monospace;
  font-size:10px;
  line-height:2;
  position:relative;
  z-index:2;

  /* note feel */
  background:
    repeating-linear-gradient(
      to bottom,
      rgba(242,169,199,.10) 0px,
      rgba(242,169,199,.10) 2px,
      transparent 2px,
      transparent 18px
    );
  box-shadow: inset 0 0 0 2px rgba(0,0,0,.06);
}

.typing::after{
  content:"";
  display:inline-block;
  width:8px;
  height:1em;
  background:#999;
  margin-left:6px;
  animation:blink .9s steps(1) infinite;
}
@keyframes blink{50%{opacity:0}}

.popupFooter{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  border-top:2px solid var(--line);
  position:relative;
  z-index:2;
}

.popupFooter button{
  padding:14px 6px;
  background:none;
  border:none;
  width:100%;
  -webkit-appearance:none;
  appearance:none;
  color:#fff; /* prevents iOS blue */
  text-align:center;

  display:flex;
  align-items:center;
  justify-content:center;

  -webkit-tap-highlight-color: transparent;
}

.popupFooter button+button{ border-left:2px solid var(--line); }

.tag{
  font-family:'Press Start 2P', monospace;
  font-size:7px;
  line-height:1.55;
  padding:8px 10px;
  border-radius:999px;
  border:2px solid var(--line);
  background:rgba(242,169,199,.55);
  color:#fff;

  display:inline-flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  max-width:100%;
  white-space:normal;
  min-height:30px;

  box-shadow:0 3px 0 rgba(0,0,0,.12);
}
.popupFooter button:active .tag{
  transform:translateY(2px);
  box-shadow:0 1px 0 rgba(0,0,0,.12);
}

.hidden{display:none}
</style>
</head>

<body>
<div class="wrap">

<section class="lock" id="lock">
  <div class="lockTop">
    <h1>Enter Passcode</h1>
    <p>the day we met</p>
    <div class="dots" id="dots"></div>
    <div class="err" id="err"></div>
  </div>

  <div class="pad">
    <button class="key" data-k="1" type="button">1</button>
    <button class="key" data-k="2" type="button">2</button>
    <button class="key" data-k="3" type="button">3</button>
    <button class="key" data-k="4" type="button">4</button>
    <button class="key" data-k="5" type="button">5</button>
    <button class="key" data-k="6" type="button">6</button>
    <button class="key" data-k="7" type="button">7</button>
    <button class="key" data-k="8" type="button">8</button>
    <button class="key" data-k="9" type="button">9</button>
    <div class="spacer"></div>
    <button class="key" data-k="0" type="button">0</button>
    <button class="key alt" data-k="del" type="button">Del</button>
  </div>
</section>

<section class="popup hidden" id="popup">
  <div class="popupHeader">
    <div class="windowDots" aria-hidden="true"><span></span><span></span><span></span></div>

    <div class="hdrLeft">
      <div>New Message</div>
      <div class="dayTracker" id="dayTracker" aria-label="Relationship counter"></div>
    </div>

    <button class="musicBtn" id="musicBtn" type="button" aria-label="Toggle music">►</button>
  </div>

  <div class="popupBody">
    <div id="msg"></div>

    <audio id="autoPlayer" preload="auto">
      <source src="audio/bg-music.mp3.mp3" type="audio/mpeg">
    </audio>
  </div>

  <div class="popupFooter">
    <button type="button" data-set="reassurance"><span class="tag">Reassurance</span></button>
    <button type="button" data-set="what"><span class="tag">What I Love</span></button>
    <button type="button" data-set="sweet"><span class="tag">Something<br>Sweet</span></button>
  </div>
</section>

</div>

<script>
/* ---------- CONFIG ---------- */
const PASS = "07242024";

/* together date */
const START_DATE = "2025-08-11";

/* his timezone */
const TZ = "Europe/London"; // Walsall (DST-safe)

/* pinned (exactly as requested) */
const PINNED = `Hello, my sweet prince.
My red string.
I made this just for you.
You can visit whenever you want.`;

/* ---------- MESSAGE BANKS ---------- */
/* Reassurance + What I Love are NOT time-based */
const SETS = {
  reassurance: [
    "You’re safe here. Nothing is required of you.",
    "You don’t have to be perfect to be loved.",
    "I’m still here. I’m not going anywhere.",
    "Breathe. Slow down. Come back to me.",
    "If today feels heavy, you don’t have to carry it alone.",
    "Start small. One thing at a time. I’ve got you.",
    "I’m proud of you for continuing.",
    "Come here. Let the world be quiet for a second.",
    "You are not a burden. Not to me.",
    "You’re allowed to have hard days."
  ],

  what: [
    "I love how thoughtful you are.",
    "I love your mind. The way you notice things other people miss.",
    "I love how gentle you can be.",
    "I love your laugh. It’s my favorite sound in my head.",
    "I love the way you try, even when it’s hard.",
    "I love your steadiness—especially on days you don’t feel steady.",
    "I love the softness you hide.",
    "I love you in the quiet. Especially in the quiet.",
    "I love the way you care so deeply.",
    "I love how you keep showing up."
  ]
};

/* Something Sweet IS time-of-day based (UK/Walsall) */
const SWEET_TOD = {
  morning: [
    "Good morning, my sweet prince.",
    "Good morning, love. I hope you slept okay.",
    "Wake up, my red string. I’m here.",
    "I wish I could pull you close before your day starts.",
    "Morning. Be good today… or don’t."
  ],
  afternoon: [
    "You crossed my mind. You never really leave it.",
    "I hope you’ve eaten something today, my love.",
    "I miss you. Quietly. Constantly.",
    "Just a little reminder: you’re mine to adore.",
    "I wish I could steal five minutes of your time and keep it."
  ],
  evening: [
    "I missed you today.",
    "Come sit with me, my sweet prince.",
    "I wish I was there—just to be near you.",
    "Let the day end in my arms, even if it’s only words.",
    "If I could, I’d pull you in and keep you there."
  ],
  night: [
    "Trouble sleeping, my love?",
    "If you’re still awake, I’m here.",
    "Come closer. Just breathe with me.",
    "I’d hold you until you fell asleep.",
    "It’s quiet. I like thinking of you like this."
  ]
};

/* Return messages (when he comes back) */
const RETURN = {
  soon: [
    "Back so soon?",
    "There you are.",
    "Couldn’t stay away, hm?"
  ],
  sameDay: [
    "I missed you.",
    "I’m glad you came back.",
    "Come here."
  ],
  long: [
    "I missed you. I really did.",
    "It’s nice to see you again, my love.",
    "I was hoping you’d come back."
  ]
};

/* ---------- ANNIVERSARY COPY (month-by-month) ---------- */
const ANNIVERSARY_MONTHLY = {
  1:  "Happy 1 month anniversary, my love.",
  2:  "Happy 2 month anniversary. Still you.",
  3:  "Three months with you. I’m grateful. Happy anniversary.",
  4:  "Happy 4 month anniversary, my red string.",
  5:  "Five months. You feel like home. Happy anniversary.",
  6:  "Happy 6 month anniversary, my love.",
  7:  "Seven months with you. Still choosing you. Happy anniversary.",
  8:  "Happy 8 month anniversary, my love.",
  9:  "Nine months. And you still make the world softer.",
  10: "Happy 10 month anniversary, my love.",
  11: "Eleven months with you. I’m proud of us.",
  12: "One year with you. I’d do it all again."
};

function yearlyAnniversaryText(years){
  if(years <= 1) return "One year with you. I’d do it all again.";
  return `Happy ${years} year anniversary, my love.`;
}

/* ---------- TIME HELPERS ---------- */
function ukNow(){
  return new Date(new Date().toLocaleString("en-US", { timeZone: TZ }));
}
function ukDateKey(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function timeBucketUK(){
  const h = ukNow().getHours();
  if(h >= 5 && h <= 11) return "morning";
  if(h >= 12 && h <= 16) return "afternoon";
  if(h >= 17 && h <= 21) return "evening";
  return "night";
}

function monthsSinceStartUK(){
  const s = new Date(new Date(START_DATE + "T00:00:00").toLocaleString("en-US",{timeZone:TZ}));
  const n = ukNow();
  return (n.getFullYear()-s.getFullYear())*12 + (n.getMonth()-s.getMonth());
}
function yearsSinceStartUK(){
  const s = new Date(new Date(START_DATE + "T00:00:00").toLocaleString("en-US",{timeZone:TZ}));
  const n = ukNow();
  let y = n.getFullYear() - s.getFullYear();
  const annThisYear = new Date(n.getFullYear(), s.getMonth(), s.getDate());
  if(n < annThisYear) y -= 1;
  return Math.max(0, y);
}
function isYearlyAnniversaryUK(){
  const s = new Date(new Date(START_DATE + "T00:00:00").toLocaleString("en-US",{timeZone:TZ}));
  const n = ukNow();
  return n.getMonth() === s.getMonth() && n.getDate() === s.getDate();
}
function isMonthlyAnniversaryUK(){
  const s = new Date(new Date(START_DATE + "T00:00:00").toLocaleString("en-US",{timeZone:TZ}));
  const n = ukNow();
  return n.getDate() === s.getDate(); // the 11th
}
function getAnniversaryMessage(){
  if(isYearlyAnniversaryUK()){
    const years = yearsSinceStartUK();
    return yearlyAnniversaryText(years);
  }
  if(isMonthlyAnniversaryUK()){
    const m = Math.max(1, monthsSinceStartUK());
    return ANNIVERSARY_MONTHLY[m] || `Happy ${m} month anniversary, my love.`;
  }
  return "";
}

/* ---------- TRACKER (combo: y/m/d + total days) ---------- */
function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function diffYMD(from, to){
  let y = to.getFullYear() - from.getFullYear();
  let m = to.getMonth() - from.getMonth();
  let d = to.getDate() - from.getDate();
  if(d < 0){
    m -= 1;
    const prevMonth = new Date(to.getFullYear(), to.getMonth(), 0);
    d += prevMonth.getDate();
  }
  if(m < 0){ y -= 1; m += 12; }
  return { y, m, d };
}
function updateDayTracker(){
  const el = document.getElementById("dayTracker");
  if(!el) return;

  const start = startOfDay(new Date(START_DATE + "T00:00:00"));
  const now   = startOfDay(new Date());

  if(now < start){
    el.textContent = `♡ 0y 0m 0d • 0 days ♡`;
    return;
  }
  const {y,m,d} = diffYMD(start, now);
  const totalDays = Math.floor((now - start) / 86400000);
  el.textContent = `♡ ${y}y ${m}m ${d}d • ${totalDays} days ♡`;
}

/* ---------- AUDIO (click + typing + music) ---------- */
let audioCtx=null;
function ensureAudio(){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==="suspended") audioCtx.resume();
}

/* button click sounds */
function clickSound(freq=620){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type="triangle";
  o.frequency.value=freq;
  g.gain.setValueAtTime(.03,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.07);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+.07);
}

function unlockSound(){
  clickSound(520); setTimeout(()=>clickSound(780),90);
}

/* softer typing sound */
function typeKeySound(){
  if(!audioCtx) return;

  const dur = 0.016;
  const buffer = audioCtx.createBuffer(1, Math.floor(audioCtx.sampleRate * dur), audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<data.length;i++){
    data[i] = (Math.random()*2-1) * (0.7 - (i/data.length)*0.6);
  }

  const src = audioCtx.createBufferSource();
  src.buffer = buffer;

  const filter = audioCtx.createBiquadFilter();
  filter.type = "bandpass";
  filter.frequency.value = 2200;
  filter.Q.value = 1.1;

  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0.006, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0008, audioCtx.currentTime + dur);

  src.connect(filter);
  filter.connect(g);
  g.connect(audioCtx.destination);

  src.start();
  src.stop(audioCtx.currentTime + dur);
}

/* ---- music control / autoplay logic ---- */
let unlocked = false;
let userPausedMusic = false;
let musicEverStarted = false;

function applyMusicDefaults(){
  const player = document.getElementById("autoPlayer");
  if(!player) return;
  player.volume = 0.45;  // tweak 0.35–0.6
  player.loop = true;
}

function tryAutoPlay(){
  const player = document.getElementById("autoPlayer");
  if(!player) return;
  applyMusicDefaults();
  player.play().then(()=>{
    musicEverStarted = true;
    updateMusicBtn();
  }).catch(()=>{});
}

const musicBtn = document.getElementById("musicBtn");
function updateMusicBtn(){
  const player = document.getElementById("autoPlayer");
  if(!player) return;
  const playing = !player.paused;
  musicBtn.textContent = playing ? "❚❚" : "►";
  musicBtn.classList.toggle("on", playing);
  musicBtn.setAttribute("aria-label", playing ? "Pause music" : "Play music");
}

musicBtn.addEventListener("click",(e)=>{
  e.stopPropagation();
  ensureAudio();
  const player = document.getElementById("autoPlayer");
  if(!player) return;

  if(player.paused){
    userPausedMusic = false;
    tryAutoPlay();
  }else{
    userPausedMusic = true;
    player.pause();
  }
  updateMusicBtn();
});

document.getElementById("autoPlayer").addEventListener("play", updateMusicBtn);
document.getElementById("autoPlayer").addEventListener("pause", updateMusicBtn);

/*
  iOS fallback:
  Only helps iOS start music the first time AFTER unlock,
  and never restarts it if you intentionally paused.
*/
document.addEventListener("click", ()=>{
  const player = document.getElementById("autoPlayer");
  if(!player) return;

  if(unlocked && !musicEverStarted && !userPausedMusic && player.paused){
    tryAutoPlay();
  }
});

/* ---------- TYPING (hesitation every other message) ---------- */
let typingTimer=null;
let messageIndex=0;

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function pickPauseIndex(text){
  const points=[];
  for(let i=10;i<text.length-10;i++){
    const ch=text[i];
    if(ch==="."||ch===","||ch==="!"||ch==="?"||ch==="…") points.push(i+1);
  }
  if(points.length) return points[Math.floor(Math.random()*points.length)];
  return Math.floor(text.length*0.55);
}

function typeText(text, onDone){
  const el=document.getElementById("msg");
  el.textContent="";
  el.classList.add("typing");

  messageIndex += 1;
  const doHesitate = (messageIndex % 2 === 0); // every other message
  const pauseAt = doHesitate ? pickPauseIndex(text) : -1;
  let paused=false;
  let i=0;

  clearInterval(typingTimer);
  typingTimer=setInterval(step, 40);

  function step(){
    if(pauseAt !== -1 && !paused && i === pauseAt){
      paused=true;
      clearInterval(typingTimer);
      setTimeout(()=>{ typingTimer=setInterval(step,40); }, 520);
      return;
    }

    const ch = text[i++] || "";
    el.textContent += ch;

    if(ch && ch !== " " && ch !== "\n"){
      if(Math.random() < 0.85) typeKeySound();
    }

    if(i>=text.length){
      clearInterval(typingTimer);
      el.classList.remove("typing");
      if(typeof onDone === "function") onDone();
    }
  }
}

/* ---------- RETURN LOGIC (with once-per-UK-day cap) ---------- */
function getReturnMessage(){
  const now = Date.now();
  const lastKey = "shyfaery_last_visit_ts_v3";
  const shownKey = "shyfaery_return_shown_day_v3";

  const last = Number(localStorage.getItem(lastKey) || 0);
  localStorage.setItem(lastKey, String(now));

  if(!last) return "";

  const todayUK = ukDateKey(ukNow());
  const shownDay = localStorage.getItem(shownKey) || "";

  // cap: show at most once per UK day
  if(shownDay === todayUK) return "";

  const mins = (now - last) / 60000;

  let msg = "";
  if(mins <= 15) msg = pick(RETURN.soon);
  else if(mins <= 12*60) msg = pick(RETURN.sameDay);
  else msg = pick(RETURN.long);

  localStorage.setItem(shownKey, todayUK);
  return msg;
}

/* ---------- FIRST BUTTON PRESS GREETING ---------- */
let firstButtonAfterUnlock = true;

/* ---------- LOCK DOTS ---------- */
const dots=document.getElementById("dots");
for(let i=0;i<PASS.length;i++) dots.appendChild(document.createElement("div")).className="dot";
let entered="";
function updateDots(){
  [...dots.children].forEach((d,i)=>d.classList.toggle("filled",i<entered.length));
}

/* ---------- UNLOCK FLOW ---------- */
function showAfterUnlock(){
  document.getElementById("lock").classList.add("hidden");
  document.getElementById("popup").classList.remove("hidden");

  updateDayTracker();
  setInterval(updateDayTracker, 60*1000);

  const ann = getAnniversaryMessage(); // replaces pinned that day
  const first = ann || PINNED;
  const ret = getReturnMessage();

  firstButtonAfterUnlock = true;

  typeText(first, ()=>{
    if(ret){
      setTimeout(()=>typeText(ret), 420);
    }
  });

  tryAutoPlay();
}

/* ---------- MAIN CLICK HANDLER ---------- */
document.addEventListener("click",(e)=>{
  ensureAudio();

  const k=e.target.closest("[data-k]");
  const b=e.target.closest("[data-set]");

  if(k){
    clickSound();

    const val=k.dataset.k;
    if(val==="del"){
      entered=entered.slice(0,-1);
      updateDots();
      return;
    }

    if(entered.length<PASS.length){
      entered+=val;
      updateDots();
    }

    if(entered.length===PASS.length){
      if(entered===PASS){
        unlockSound();
        unlocked=true;
        showAfterUnlock();
      } else {
        document.getElementById("err").textContent="Wrong code.";
      }
      entered="";
      updateDots();
    }
  }

  if(b && unlocked){
    clickSound();

    // first button press after unlock ALWAYS gives a time-based Sweet greeting
    if(firstButtonAfterUnlock){
      firstButtonAfterUnlock = false;
      const bucket = timeBucketUK();
      const pool = SWEET_TOD[bucket] || SWEET_TOD.evening;
      typeText(pick(pool));
      return;
    }

    const cat = b.dataset.set; // reassurance | what | sweet

    if(cat === "sweet"){
      const bucket = timeBucketUK();
      const pool = SWEET_TOD[bucket] || SWEET_TOD.evening;
      typeText(pick(pool));
    } else {
      const pool = SETS[cat] || SETS.reassurance;
      typeText(pick(pool));
    }
  }
});

applyMusicDefaults();
updateMusicBtn();
</script>
</body>
</html>
