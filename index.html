<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>New Message</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
:root{
  --pink:#f2a9c7;
  --pink2:rgba(242,169,199,.55);
  --bgpink:rgba(242,169,199,.45);
  --line:rgba(0,0,0,.18);
  --shadow:rgba(0,0,0,.12);
}

*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:24px;
  overflow-y:auto;
  background:
    repeating-linear-gradient(
      90deg,
      var(--bgpink) 0px,
      var(--bgpink) 22px,
      #fff 22px,
      #fff 48px
    );
}

.wrap{
  width:420px;
  max-width:95vw;
  margin:140px auto 40px;
}

/* ---------- LOCK ---------- */
.lock{
  background:#fff;
  border:2px solid var(--line);
  border-radius:20px;
  box-shadow:0 16px 36px var(--shadow);
  overflow:hidden;
}

.lockTop{
  padding:18px 16px 8px;
  text-align:center;
  font-family:'Press Start 2P', monospace;
}

.lockTop h1{
  font-size:14px;
  margin:6px 0 10px;
}

.lockTop p{
  font-size:10px;
  opacity:.7;
  margin-bottom:10px;
}

.dots{
  display:flex;
  justify-content:center;
  gap:6px;
  margin-bottom:8px;
}

.dot{
  width:12px;
  height:12px;
  border-radius:50%;
  border:2px solid var(--line);
}

.dot.filled{background:var(--pink)}

.err{
  height:16px;
  font-size:9px;
  color:#a33;
}

/* keypad */
.pad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  padding:14px;
  border-top:2px solid var(--line);
}

.key{
  padding:14px 0;
  font-family:'Press Start 2P', monospace;
  font-size:14px;
  border-radius:14px;
  border:2px solid var(--line);
  background:var(--pink);
  color:#fff;
}

.key.alt{
  background:#f7f7f7;
  color:#222;
  font-size:9px;
}

.spacer{visibility:hidden}

/* ---------- POPUP ---------- */
.popup{
  background:#fff;
  border-radius:20px;
  border:2px solid var(--line);
  overflow:hidden;
  width:360px;
  max-width:92vw;

  position:relative; /* for overlays */
  /* ✅ blush glow + your original sticker shadow */
  box-shadow:
    14px 14px 0 rgba(242,169,199,.55),
    0 0 0 6px rgba(242,169,199,.10);
}

/* ✅ subtle sparkle / grain overlay */
.popup::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background: radial-gradient(rgba(255,255,255,.35) 1px, transparent 1px);
  background-size:10px 10px;
  opacity:.22;
}

/* header */
.popupHeader{
  background:var(--pink2);
  padding:14px;
  text-align:center;
  font-family:'Press Start 2P', monospace;
  font-size:14px;
  position:relative;
  z-index:2; /* above sparkle overlay */
}

/* ✅ cute window dots */
.windowDots{
  position:absolute;
  left:12px;
  top:12px;
  display:flex;
  gap:6px;
  z-index:3;
}
.windowDots span{
  width:10px; height:10px;
  border-radius:50%;
  border:2px solid var(--line);
  background:rgba(255,255,255,.75);
}
.windowDots span:nth-child(1){ background:rgba(242,169,199,.60); }
.windowDots span:nth-child(2){ background:rgba(255,255,255,.78); }
.windowDots span:nth-child(3){ background:rgba(242,169,199,.35); }

/* title + tracker stack */
/* pad right so it never sits under music button */
.hdrLeft{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  padding-right:44px;
  position:relative;
  z-index:3;
}

/* tracker pill */
.dayTracker{
  font-family:'Press Start 2P', monospace;
  font-size:8px;
  line-height:1.35;
  padding:6px 8px;
  border-radius:999px;
  border:2px solid var(--line);
  background:rgba(255,255,255,.90);
  color:#222;
  max-width:260px;
  text-align:center;
  white-space:normal;
  letter-spacing:.2px;
}

/* music control button */
.musicBtn{
  position:absolute;
  right:10px;
  top:10px;
  width:34px;
  height:26px;
  border-radius:10px;
  border:2px solid var(--line);
  background:#fff;
  color:#222 !important; /* ✅ prevent iOS blue */
  font-family:'Press Start 2P', monospace;
  font-size:10px;
  line-height:1;
  display:flex;
  align-items:center;
  justify-content:center;
  -webkit-appearance:none;
  appearance:none;
  padding:0;
  z-index:6; /* ✅ above everything */
  -webkit-tap-highlight-color: transparent;
}
.musicBtn:active{transform:translateY(1px)}
.musicBtn.on{ background:rgba(242,169,199,.35); }

.popupBody{
  padding:18px 16px;
  min-height:120px;
  font-family:'Press Start 2P', monospace;
  font-size:10px;
  line-height:2;
  position:relative;
  z-index:2;

  /* ✅ "note" feel: faint lines + soft inner border */
  background:
    repeating-linear-gradient(
      to bottom,
      rgba(242,169,199,.10) 0px,
      rgba(242,169,199,.10) 2px,
      transparent 2px,
      transparent 18px
    );
  box-shadow: inset 0 0 0 2px rgba(0,0,0,.06);
}

.typing::after{
  content:"";
  display:inline-block;
  width:8px;
  height:1em;
  background:#999;
  margin-left:6px;
  animation:blink .9s steps(1) infinite;
}

@keyframes blink{50%{opacity:0}}

.popupFooter{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  border-top:2px solid var(--line);
  position:relative;
  z-index:2;
}

/* footer buttons flex-center so pills never squish */
.popupFooter button{
  padding:14px 6px;
  background:none;
  border:none;
  width:100%;
  -webkit-appearance:none;
  appearance:none;
  color:#fff; /* prevents iOS blue */
  text-align:center;

  display:flex;
  align-items:center;
  justify-content:center;
}

.popupFooter button+button{
  border-left:2px solid var(--line);
}

.tag{
  font-family:'Press Start 2P', monospace;
  font-size:7px;
  line-height:1.55;
  padding:8px 10px;
  border-radius:999px;
  border:2px solid var(--line);
  background:rgba(242,169,199,.55);
  color:#fff;

  display:inline-flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  max-width:100%;
  white-space:normal;
  min-height:28px;

  /* ✅ pressable */
  box-shadow:0 3px 0 rgba(0,0,0,.12);
}
.popupFooter button:active .tag{
  transform:translateY(2px);
  box-shadow:0 1px 0 rgba(0,0,0,.12);
}

.hidden{display:none}

/* --- kawaii heart pop --- */
.heartPop{
  position:absolute;
  left: var(--x, 50%);
  top:  var(--y, 50%);
  transform: translate(-50%,-50%) scale(.6);
  width:18px;
  height:18px;
  pointer-events:none;
  opacity:0;
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.12));
  animation: heartPop 900ms cubic-bezier(.2,1.1,.25,1) forwards;
  z-index:10;
}
.heartPop::before,
.heartPop::after{
  content:"";
  position:absolute;
  width:10px;
  height:10px;
  background: rgba(242,169,199,.95);
  border:2px solid rgba(0,0,0,.12);
  border-radius:999px;
  top:0;
}
.heartPop::before{ left:4px; }
.heartPop::after{ left:0; }

.heartPop .tail{
  position:absolute;
  left:4px;
  top:6px;
  width:10px;
  height:10px;
  background: rgba(242,169,199,.95);
  border:2px solid rgba(0,0,0,.12);
  transform: rotate(45deg);
  border-radius:3px;
}

.heartSpark{
  position:absolute;
  left:50%;
  top:50%;
  width:4px;
  height:4px;
  border-radius:999px;
  background:rgba(255,255,255,.95);
  transform: translate(-50%,-50%);
  opacity:.9;
  animation: spark 900ms ease-out forwards;
}

@keyframes heartPop{
  0%   {opacity:0; transform:translate(-50%,-50%) scale(.55) rotate(-6deg);}
  12%  {opacity:1;}
  40%  {opacity:1; transform:translate(-50%,-62%) scale(1.15) rotate(6deg);}
  70%  {opacity:.95; transform:translate(-50%,-74%) scale(1.0) rotate(0deg);}
  100% {opacity:0; transform:translate(-50%,-92%) scale(.9) rotate(0deg);}
}
@keyframes spark{
  0%   {opacity:0; transform:translate(-50%,-50%) scale(.5);}
  30%  {opacity:.9;}
  100% {opacity:0; transform:translate(-50%,-85%) scale(1.6);}
}
</style>
</head>

<body>
<div class="wrap">

<section class="lock" id="lock">
  <div class="lockTop">
    <h1>Enter Passcode</h1>
    <p>the day we met</p>
    <div class="dots" id="dots"></div>
    <div class="err" id="err"></div>
  </div>

  <div class="pad">
    <button class="key" data-k="1">1</button>
    <button class="key" data-k="2">2</button>
    <button class="key" data-k="3">3</button>
    <button class="key" data-k="4">4</button>
    <button class="key" data-k="5">5</button>
    <button class="key" data-k="6">6</button>
    <button class="key" data-k="7">7</button>
    <button class="key" data-k="8">8</button>
    <button class="key" data-k="9">9</button>
    <div class="spacer"></div>
    <button class="key" data-k="0">0</button>
    <button class="key alt" data-k="del">Del</button>
  </div>
</section>

<section class="popup hidden" id="popup">
  <div class="popupHeader">
    <div class="windowDots" aria-hidden="true">
      <span></span><span></span><span></span>
    </div>

    <div class="hdrLeft">
      <div>New Message</div>
      <div class="dayTracker" id="dayTracker" aria-label="Relationship counter"></div>
    </div>

    <button class="musicBtn" id="musicBtn" type="button" aria-label="Toggle music">►</button>
  </div>

  <div class="popupBody">
    <div id="msg"></div>

    <audio id="autoPlayer" preload="auto">
      <source src="audio/bg-music.mp3.mp3" type="audio/mpeg">
    </audio>
  </div>

  <div class="popupFooter">
    <button type="button" data-set="reassurance"><span class="tag">Reassurance</span></button>
    <button type="button" data-set="what"><span class="tag">What I Love</span></button>
    <button type="button" data-set="sweet"><span class="tag">Something<br>Sweet</span></button>
  </div>
</section>

</div>

<script>
const PASS = "07242024";

/* ✅ together date (Aug 11, 2025) */
const START_DATE = "2025-08-11";

const sets = {
  reassurance: [
    "Sometimes I don’t think you realize the depth of what you've done to me. I am no longer able to look at another and feel any sort of wanting. It’s you, or it’s no one.",
    "My heart belongs to you, and only you forever. If my future isn’t with you, I would rather be alone. There is no one else.",
    "I am here. I will always be here.",
    "You do not have to carry everything alone.",
    "I believe you."
  ],
  what: [
    "I love your eyes. They're such a pretty shade of green.",
    "I love your hair, and the way your messy 'lil curls fall over your face. You always say that your hair is messy, but I love how it looks.",
    "I love your patience.",
    "I love how deeply you care.",
    "I love how you keep trying."
  ],
  sweet: [
    "I don’t remember what my thoughts sounded like before they learned your name. You are woven into who I am, and I cannot imagine a life without you now.",
    "From the moment we met, I knew it was only a matter of time before you sunk deep beneath my bones and consumed me whole. I couldn't stop loving you even if I tried to.",
    "I am really glad I get to love you.",
    "Come here. I owe you a hug.",
    "You make my days softer."
  ]
};

/* ---- tracker (combo: y/m/d + total days) ---- */
function startOfDay(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function diffYMD(from, to){
  let y = to.getFullYear() - from.getFullYear();
  let m = to.getMonth() - from.getMonth();
  let d = to.getDate() - from.getDate();

  if(d < 0){
    m -= 1;
    const prevMonth = new Date(to.getFullYear(), to.getMonth(), 0);
    d += prevMonth.getDate();
  }
  if(m < 0){
    y -= 1;
    m += 12;
  }
  return {y,m,d};
}
function updateDayTracker(){
  const el = document.getElementById("dayTracker");
  if(!el) return;

  const start = startOfDay(new Date(START_DATE + "T00:00:00"));
  const now   = startOfDay(new Date());

  if(now < start){
    el.textContent = `♡ 0y 0m 0d • 0 days ♡`;
    return;
  }

  const {y,m,d} = diffYMD(start, now);
  const totalDays = Math.floor((now - start) / 86400000);

  el.textContent = `♡ ${y}y ${m}m ${d}d • ${totalDays} days ♡`;
}

/* ---- kawaii heart pop ---- */
function popHeart(hostEl){
  const host = hostEl || document.querySelector(".popupBody") || document.body;
  const rect = host.getBoundingClientRect();

  const x = rect.left + rect.width * (0.55 + (Math.random()*0.12 - 0.06));
  const y = rect.top  + rect.height * (0.22 + (Math.random()*0.10));

  const h = document.createElement("div");
  h.className = "heartPop";
  h.style.setProperty("--x", x + "px");
  h.style.setProperty("--y", y + "px");

  const tail = document.createElement("div");
  tail.className = "tail";
  h.appendChild(tail);

  const s = document.createElement("div");
  s.className = "heartSpark";
  h.appendChild(s);

  document.body.appendChild(h);
  setTimeout(()=>h.remove(), 950);
}

/* ----- audio context ----- */
let audioCtx=null;
function ensureAudio(){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==="suspended") audioCtx.resume();
}

/* button click sounds */
function clickSound(freq=620){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type="triangle";
  o.frequency.value=freq;
  g.gain.setValueAtTime(.03,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.07);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+.07);
}

function unlockSound(){
  clickSound(520); setTimeout(()=>clickSound(780),90);
}

/* ---- softer, more "real typing" sound ---- */
function typeKeySound(){
  if(!audioCtx) return;

  const dur = 0.016;
  const buffer = audioCtx.createBuffer(1, Math.floor(audioCtx.sampleRate * dur), audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<data.length;i++){
    data[i] = (Math.random()*2-1) * (0.7 - (i/data.length)*0.6);
  }

  const src = audioCtx.createBufferSource();
  src.buffer = buffer;

  const filter = audioCtx.createBiquadFilter();
  filter.type = "bandpass";
  filter.frequency.value = 2200;
  filter.Q.value = 1.1;

  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0.006, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0008, audioCtx.currentTime + dur);

  src.connect(filter);
  filter.connect(g);
  g.connect(audioCtx.destination);

  src.start();
  src.stop(audioCtx.currentTime + dur);
}

/* typing */
let typingTimer=null;
function typeText(text){
  const el=document.getElementById("msg");
  el.textContent="";
  el.classList.add("typing");
  let i=0;
  clearInterval(typingTimer);

  typingTimer=setInterval(()=>{
    const ch = text[i++] || "";
    el.textContent += ch;

    if(ch && ch !== " " && ch !== "\n"){
      if(Math.random() < 0.85) typeKeySound();
    }

    if(i>=text.length){
      clearInterval(typingTimer);
      el.classList.remove("typing");
      popHeart(document.querySelector(".popupBody")); /* ✅ pop after message finishes */
    }
  }, 40);
}

/* lock dots */
const dots=document.getElementById("dots");
for(let i=0;i<PASS.length;i++) dots.appendChild(document.createElement("div")).className="dot";
let entered="";
function updateDots(){
  [...dots.children].forEach((d,i)=>d.classList.toggle("filled",i<entered.length));
}

/* ---- music control / autoplay logic ---- */
let unlocked = false;
let userPausedMusic = false;
let musicEverStarted = false;

function applyMusicDefaults(){
  const player = document.getElementById("autoPlayer");
  if(!player) return;
  player.volume = 0.45;
  player.loop = true;
}

function tryAutoPlay(){
  const player = document.getElementById("autoPlayer");
  if(!player) return;
  applyMusicDefaults();
  player.play().then(()=>{
    musicEverStarted = true;
    updateMusicBtn();
  }).catch(()=>{});
}

const musicBtn = document.getElementById("musicBtn");
function updateMusicBtn(){
  const player = document.getElementById("autoPlayer");
  if(!player) return;
  const playing = !player.paused;
  musicBtn.textContent = playing ? "❚❚" : "►";
  musicBtn.classList.toggle("on", playing);
  musicBtn.setAttribute("aria-label", playing ? "Pause music" : "Play music");
}

musicBtn.addEventListener("click",(e)=>{
  e.stopPropagation();
  ensureAudio();
  const player = document.getElementById("autoPlayer");
  if(!player) return;

  if(player.paused){
    userPausedMusic = false;
    tryAutoPlay();
  }else{
    userPausedMusic = true;
    player.pause();
  }
  updateMusicBtn();
});

document.getElementById("autoPlayer").addEventListener("play", updateMusicBtn);
document.getElementById("autoPlayer").addEventListener("pause", updateMusicBtn);

/* main click handler */
document.addEventListener("click",e=>{
  ensureAudio();

  const k=e.target.closest("[data-k]");
  const b=e.target.closest("[data-set]");

  if(k){
    clickSound();
    if(k.dataset.k==="del"){entered=entered.slice(0,-1);updateDots();return;}
    if(entered.length<PASS.length){entered+=k.dataset.k;updateDots();}
    if(entered.length===PASS.length){
      if(entered===PASS){
        unlockSound();
        unlocked = true;

        document.getElementById("lock").classList.add("hidden");
        document.getElementById("popup").classList.remove("hidden");

        updateDayTracker();
        setInterval(updateDayTracker, 60 * 1000);

        typeText(sets.sweet[Math.floor(Math.random()*sets.sweet.length)]);

        tryAutoPlay();
      } else {
        entered=""; updateDots();
      }
    }
  }

  if(b){
    clickSound();
    typeText(sets[b.dataset.set][Math.floor(Math.random()*sets[b.dataset.set].length)]);
    popHeart(document.querySelector(".popupBody")); /* ✅ extra pop on button press */
  }
});

/* iOS fallback: only start music once AFTER unlock, never restart if user paused */
document.addEventListener("click", ()=>{
  const player = document.getElementById("autoPlayer");
  if(!player) return;

  if(unlocked && !musicEverStarted && !userPausedMusic && player.paused){
    tryAutoPlay();
  }
});

applyMusicDefaults();
updateMusicBtn();
</script>
</body>
</html>
